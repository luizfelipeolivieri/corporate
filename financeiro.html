<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Financeiro | Controle de Gastos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
body { margin:0; font-family:Arial; background:#f4f4f4; }
header { background:#000; color:#fff; padding:20px; }
.nav { max-width:1400px; margin:auto; display:flex; justify-content:space-between; }
.container { max-width:1400px; margin:20px auto; overflow-x:auto; }
table { border-collapse:collapse; width:100%; font-size:12px; background:#fff; }
th,td { border:1px solid #999; padding:6px; text-align:center; }
th { background:#003cff; color:#fff; }
td.categoria { background:#eee; font-weight:bold; text-align:left; }
td.sub { text-align:left; padding-left:15px; }
input.valor { width:80px; border:none; text-align:right; }
.total { background:#000; color:#fff; font-weight:bold; }
.renda { background:#ffe766; font-weight:bold; }
.resultado { background:#00a2ff; color:#fff; font-weight:bold; }
</style>
</head>

<body>

<header>
<div class="nav">
<strong>OLIVIERI | Financeiro</strong>
<div id="userArea"></div>
</div>
</header>

<div class="container">

<table>
<thead>
<tr>
<th>Despesas</th>
<th>Jan</th><th>Meio</th>
<th>Fev</th><th>Meio</th>
<th>Mar</th><th>Meio</th>
<th>Abr</th><th>Meio</th>
</tr>
</thead>

<tbody>

<tr><td class="categoria">Alimenta√ß√£o</td><td colspan="8"></td></tr>
<tr>
<td class="sub">Supermercado</td>
<td><input class="valor gasto" data-mes="jan" data-categoria="alimentacao" data-item="supermercado"></td><td></td>
<td><input class="valor gasto" data-mes="fev" data-categoria="alimentacao" data-item="supermercado"></td><td></td>
<td><input class="valor gasto" data-mes="mar" data-categoria="alimentacao" data-item="supermercado"></td><td></td>
<td><input class="valor gasto" data-mes="abr" data-categoria="alimentacao" data-item="supermercado"></td><td></td>
</tr>

<tr><td class="categoria">Moradia</td><td colspan="8"></td></tr>
<tr>
<td class="sub">Aluguel</td>
<td><input class="valor gasto" data-mes="jan" data-categoria="moradia" data-item="aluguel"></td><td></td>
<td><input class="valor gasto" data-mes="fev" data-categoria="moradia" data-item="aluguel"></td><td></td>
<td><input class="valor gasto" data-mes="mar" data-categoria="moradia" data-item="aluguel"></td><td></td>
<td><input class="valor gasto" data-mes="abr" data-categoria="moradia" data-item="aluguel"></td><td></td>
</tr>

<tr class="total">
<td>Total das Despesas</td>
<td colspan="2" id="total-jan">R$ 0,00</td>
<td colspan="2" id="total-fev">R$ 0,00</td>
<td colspan="2" id="total-mar">R$ 0,00</td>
<td colspan="2" id="total-abr">R$ 0,00</td>
</tr>

<tr class="renda">
<td>Renda Mensal</td>
<td colspan="2"><input class="valor renda" data-mes="jan" data-categoria="renda" data-item="mensal"></td>
<td colspan="2"><input class="valor renda" data-mes="fev" data-categoria="renda" data-item="mensal"></td>
<td colspan="2"><input class="valor renda" data-mes="mar" data-categoria="renda" data-item="mensal"></td>
<td colspan="2"><input class="valor renda" data-mes="abr" data-categoria="renda" data-item="mensal"></td>
</tr>

<tr class="resultado">
<td>Resultado Operacional</td>
<td colspan="2" id="res-jan">R$ 0,00</td>
<td colspan="2" id="res-fev">R$ 0,00</td>
<td colspan="2" id="res-mar">R$ 0,00</td>
<td colspan="2" id="res-abr">R$ 0,00</td>
</tr>

</tbody>
</table>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDByExIuGOyp5Oelr0wA_4EUnVKgq6Xiq0",
  authDomain: "corporatelogin-305a5.firebaseapp.com",
  projectId: "corporatelogin-305a5"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

firebase.auth().onAuthStateChanged(async user => {
  if (!user) { location.href="./login.html"; return; }
  userArea.innerText = "üë§ " + user.email;
  const uid = user.uid;

  document.querySelectorAll("input").forEach(input => {
    input.addEventListener("input", () => {
      salvar(uid, input);
      calcularTudo(input.dataset.mes);
    });
  });

  ["jan","fev","mar","abr"].forEach(async mes => {
    const doc = await db.collection("users").doc(uid)
      .collection("financeiro").doc(mes).get();

    if (doc.exists) {
      const dados = doc.data();
      for (let cat in dados)
        for (let item in dados[cat]) {
          const campo = document.querySelector(
            `[data-mes="${mes}"][data-categoria="${cat}"][data-item="${item}"]`
          );
          if (campo) campo.value = dados[cat][item];
        }
      calcularTudo(mes);
    }
  });
});

function salvar(uid, input) {
  db.collection("users").doc(uid)
    .collection("financeiro").doc(input.dataset.mes)
    .set({
      [input.dataset.categoria]: {
        [input.dataset.item]: Number(input.value) || 0
      }
    }, { merge:true });
}

function calcularTudo(mes) {
  let total = 0;
  document.querySelectorAll(`.gasto[data-mes="${mes}"]`)
    .forEach(i => total += Number(i.value) || 0);

  document.getElementById(`total-${mes}`).innerText =
    total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

  const renda = document.querySelector(`.renda[data-mes="${mes}"]`);
  const r = renda ? Number(renda.value) || 0 : 0;

  document.getElementById(`res-${mes}`).innerText =
    (r - total).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}
</script>

</body>
</html>
