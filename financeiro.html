<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Financeiro | Controle de Gastos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
body {
    margin: 0;
    font-family: "Segoe UI", Arial, sans-serif;
    background: #1f1f1f;
    color: #eaeaea;
}

header {
    background: #000;
    padding: 15px 0;
    border-bottom: 2px solid #201640;
}

.nav {
    max-width: 1600px;
    margin: auto;
    padding: 0 15px;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
}

select {
    background: #201640;
    color: #fff;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
}

.container {
    max-width: 1600px;
    margin: 20px auto;
    padding: 0 10px;
}

table {
    width: 100%;
    border-collapse: collapse;
    background: #2a2a2a;
    font-size: 12px;
}

th, td {
    border: 1px solid #3a3a3a;
    padding: 8px;
    text-align: center;
}

th {
    background: #201640;
    color: #fff;
}

td.categoria {
    text-align: left;
    font-weight: bold;
    background: #262626;
}

td.sub {
    text-align: left;
    padding-left: 18px;
}

input.valor {
    width: 80px;
    background: transparent;
    border: none;
    border-bottom: 1px solid #555;
    color: #fff;
    text-align: right;
}

.total {
    background: #111;
    font-weight: bold;
}

.renda {
    background: #3b3b00;
    font-weight: bold;
}

.resultado.positivo {
    background: #0f3d1f;
}

.resultado.negativo {
    background: rgb(101 0 0);
    color: #fff;
}

/* MOBILE */
@media (max-width: 900px) {
    table thead th:not(:first-child),
    table tbody td:not(:first-child) {
        display: none;
    }

    table.mobile th.mes-ativo,
    table.mobile td.mes-ativo {
        display: table-cell !important;
    }
}

.card {
    background: #2a2a2a;
    padding: 20px;
    border-radius: 10px;
    margin-top: 30px;
}
</style>
</head>

<body>

<header>
<div class="nav">
    <strong>OLIVIERI | Financeiro</strong>

    <div>
        Ano:
        <select id="anoSelect"></select>

        MÃªs:
        <select id="mesSelect"></select>
    </div>

    <div id="userArea">Carregando...</div>
</div>
</header>

<div class="container">

<table id="tabela">
<thead>
<tr>
<th>Despesas</th>
<script>
const meses = [
  {id:'jan', nome:'Jan'}, {id:'fev', nome:'Fev'}, {id:'mar', nome:'Mar'},
  {id:'abr', nome:'Abr'}, {id:'mai', nome:'Mai'}, {id:'jun', nome:'Jun'},
  {id:'jul', nome:'Jul'}, {id:'ago', nome:'Ago'}, {id:'set', nome:'Set'},
  {id:'out', nome:'Out'}, {id:'nov', nome:'Nov'}, {id:'dez', nome:'Dez'}
];
document.write(meses.map(m => `<th class="mes-${m.id}">${m.nome}</th>`).join(""));
</script>
</tr>
</thead>

<tbody>

<tr><td class="categoria">AlimentaÃ§Ã£o</td>
<script>
document.write(meses.map(m => `
<td class="mes-${m.id}">
<input class="valor gasto" data-mes="${m.id}" data-categoria="alimentacao" data-item="supermercado">
</td>`).join(""));
</script>
</tr>

<tr><td class="categoria">Moradia</td>
<script>
document.write(meses.map(m => `
<td class="mes-${m.id}">
<input class="valor gasto" data-mes="${m.id}" data-categoria="moradia" data-item="aluguel">
</td>`).join(""));
</script>
</tr>

<tr class="total">
<td>Total</td>
<script>
document.write(meses.map(m => `<td id="total-${m.id}" class="mes-${m.id}">R$ 0,00</td>`).join(""));
</script>
</tr>

<tr class="renda">
<td>Renda</td>
<script>
document.write(meses.map(m => `
<td class="mes-${m.id}">
<input class="valor renda" data-mes="${m.id}" data-categoria="renda" data-item="mensal">
</td>`).join(""));
</script>
</tr>

<tr>
<td>Resultado</td>
<script>
document.write(meses.map(m => `<td id="res-${m.id}" class="resultado mes-${m.id}">R$ 0,00</td>`).join(""));
</script>
</tr>

</tbody>
</table>

<!-- CALCULADORA -->
<div class="card">
<h3>ðŸ’³ Vale a pena comprar Ã  vista ou a prazo?</h3>

<p>
Valor Ã  vista: <input id="avista" class="valor"><br><br>
Valor da parcela: <input id="parcela" class="valor">
Qtd parcelas: <input id="qtd" class="valor">
</p>

<button onclick="calcular()">Calcular</button>

<p id="calcResultado"></p>
</div>

</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDByExIuGOyp5Oelr0wA_4EUnVKgq6Xiq0",
  authDomain: "corporatelogin-305a5.firebaseapp.com",
  projectId: "corporatelogin-305a5"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const anoAtual = new Date().getFullYear();
const anoSelect = document.getElementById("anoSelect");
for(let a = anoAtual - 5; a <= anoAtual + 1; a++){
  anoSelect.innerHTML += `<option>${a}</option>`;
}
anoSelect.value = anoAtual;

const mesSelect = document.getElementById("mesSelect");
meses.forEach(m => mesSelect.innerHTML += `<option value="${m.id}">${m.nome}</option>`);
mesSelect.value = 'jan';

function atualizarMobile(){
  document.querySelector("table").classList.add("mobile");
  meses.forEach(m=>{
    document.querySelectorAll(".mes-"+m.id)
      .forEach(td=>td.classList.remove("mes-ativo"));
  });
  document.querySelectorAll(".mes-"+mesSelect.value)
    .forEach(td=>td.classList.add("mes-ativo"));
}
mesSelect.onchange = atualizarMobile;
window.onresize = atualizarMobile;

function formatar(v){
  return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

firebase.auth().onAuthStateChanged(async user=>{
  if(!user) location.href="./login.html";
  document.getElementById("userArea").innerText="ðŸ‘¤ "+user.email;

  const uid=user.uid;

  document.querySelectorAll(".valor").forEach(input=>{
    input.oninput=()=>{
      const mes=input.dataset.mes;
      const ano=anoSelect.value;
      const cat=input.dataset.categoria;
      const item=input.dataset.item;

      db.collection("users").doc(uid)
        .collection("financeiro").doc(ano)
        .collection("meses").doc(mes)
        .set({[cat]:{[item]:Number(input.value)||0}},{merge:true});

      recalcular(mes);
    };
  });

  function recalcular(mes){
    let total=0;
    document.querySelectorAll(`.gasto[data-mes="${mes}"]`)
      .forEach(i=>total+=Number(i.value)||0);

    const renda=Number(
      document.querySelector(`.renda[data-mes="${mes}"]`)?.value||0
    );

    document.getElementById("total-"+mes).innerText=formatar(total);

    const res=renda-total;
    const cell=document.getElementById("res-"+mes);
    cell.innerText=formatar(res);
    cell.className="resultado "+(res<0?"negativo":"positivo");
  }
});

function calcular(){
  const avista=Number(avista.value||0);
  const parcela=Number(parcela.value||0);
  const qtd=Number(qtd.value||0);
  const totalPrazo=parcela*qtd;
  const economia=totalPrazo-avista;
  const juros=((economia/avista)*100).toFixed(2);

  calcResultado.innerHTML=`
  Total a prazo: ${formatar(totalPrazo)}<br>
  Economia Ã  vista: ${formatar(economia)}<br>
  Juros embutidos: ${juros}%
  `;
}
</script>

</body>
</html>
